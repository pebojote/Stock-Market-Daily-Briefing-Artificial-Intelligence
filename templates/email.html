<!doctype html>
<html>
  <body style="margin:0;background:#f9fafb;font-family:Segoe UI, Roboto, Helvetica, Arial, sans-serif;">
    <div style="max-width:860px;margin:0 auto;padding:24px;">
      <div style="background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;padding:20px 20px 8px 20px;">
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <div style="font-size:22px;font-weight:800;color:#111827;">üìä Daily Market Briefing</div>
          <div style="font-size:12px;color:#6b7280;">{{ session }} ‚Ä¢ {{ date }}</div>
        </div>

        <hr style="border:none;border-top:1px solid #e5e7eb;margin:12px 0 16px 0;" />

        <!-- 1. Market Overview -->
        <div style="margin:4px 0 10px 0;">
          <div style="font-weight:700;color:#111827;margin-bottom:6px;">1. Market Overview</div>
          <div style="font-size:14px;color:#111827;">
            üåç Sentiment: <strong>{{ market_overview.sentiment }}</strong><br/>
            üìä Indexes: S&P 500 ‚Äî <strong>{{ market_overview.indexes.sp500 }}</strong> ¬∑ Nasdaq ‚Äî <strong>{{ market_overview.indexes.nasdaq }}</strong>
          </div>
          {% if market_overview.economic_events %}
          <p style="font-size:14px;color:#111827;margin-top:8px;"><strong>Major Economic Events:</strong></p>
          <ul style='margin:8px 0 0 18px;color:#111827;font-size:14px;'>
            {% for event in market_overview.economic_events %}
            <li>{{ event }}</li>
            {% endfor %}
          </ul>
          {% endif %}
        </div>

        <!-- 2. Stock Watchlist -->
        <div style="margin:16px 0 10px 0;">
          <div style="font-weight:700;color:#111827;margin-bottom:6px;">2. Stock Watchlist</div>
          <table role="grid" cellspacing="0" cellpadding="0" style="width:100%;border-collapse:collapse;background:#ffffff;border:1px solid #e5e7eb;border-radius:8px;overflow:hidden;">
            <thead>
              <tr style="background:#f3f4f6;">
                <th style="text-align:left;padding:10px 12px;font-size:13px;color:#374151;">Ticker</th>
                <th style="text-align:left;padding:10px 12px;font-size:13px;color:#374151;">Details</th>
                <th style="text-align:left;padding:10px 12px;font-size:13px;color:#374151;">Rank</th>
                <th style="text-align:left;padding:10px 12px;font-size:13px;color:#374151;">Action</th>
              </tr>
            </thead>
            <tbody>
              {% for s in watchlist %}
              <tr>
                <td style='padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:14px;color:#111827;vertical-align:top;'><strong>{{ s.ticker }}</strong></td>
                <td style='padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:14px;color:#111827;'>
                  <strong>S/R:</strong> {{ s.support }} / {{ s.resistance }} | <strong>RSI:</strong> {{ s.rsi }} | <strong>MACD:</strong> {{ s.macd }}<br/>
                  <strong>MAs:</strong> {{ s.moving_averages }}<br/>
                  <strong>Patterns:</strong> {{ s.patterns | join(', ') }}<br/>
                  <strong>Entry:</strong> {{ s.suggested_entry }}<br/>
                  {% if s.news %}
                  <strong>News:</strong>
                  <ul>{% for n in s.news %}<li>{{ n }}</li>{% endfor %}</ul>
                  {% endif %}
                </td>
                <td style='padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:14px;vertical-align:top;'><span style="background:{{ rank_color(s.rank) }};color:#ffffff;padding:2px 8px;border-radius:999px;font-weight:600;font-size:12px;display:inline-block;">{{ s.rank }}</span></td>
                <td style='padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:14px;vertical-align:top;'><span style="background:{{ action_color(s.action) }};color:#ffffff;padding:2px 8px;border-radius:999px;font-weight:600;font-size:12px;display:inline-block;">{{ s.action }}</span></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- 3. Open Positions -->
        <div style="margin:16px 0 10px 0;">
          <div style="font-weight:700;color:#111827;margin-bottom:6px;">3. Open Positions</div>
          <table role="grid" cellspacing="0" cellpadding="0" style="width:100%;border-collapse:collapse;background:#ffffff;border:1px solid #e5e7eb;border-radius:8px;overflow:hidden;">
            <thead>
              <tr style="background:#f3f4f6;">
                <th style="text-align:left;padding:10px 12px;font-size:13px;color:#374151;">Ticker</th>
                <th style="text-align:left;padding:10px 12px;font-size:13px;color:#374151;">P/L</th>
                <th style="text-align:left;padding:10px 12px;font-size:13px;color:#374151;">Analysis</th>
              </tr>
            </thead>
            <tbody>
              {% for p in open_positions %}
              <tr style='{{ risk_row_style(pct(p.entry_price, p.current_price)) }}'>
                <td style='padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:14px;color:#111827;vertical-align:top;'><strong>{{ p.ticker }}</strong></td>
                <td style='padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:14px;color:{{ '#16a34a' if pct(p.entry_price, p.current_price) > 0 else ('#dc2626' if pct(p.entry_price, p.current_price) < 0 else '#374151') }};'>{{ pct(p.entry_price, p.current_price) | format_percent }}</td>
                <td style='padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:14px;color:#111827;'>
                  <strong>Outlook:</strong> {{ p.outlook }}<br/>
                  <strong>Action:</strong> {{ p.action_suggestion }}<br/>
                  <strong>Target:</strong> {{ p.target_sell_zone }}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- 4. Trade Journal -->
        <div style="margin:16px 0 10px 0;">
          <div style="font-weight:700;color:#111827;margin-bottom:6px;">4. Trade Journal Summary</div>
          <ul style='margin:6px 0 0 18px;padding:0;font-size:14px;'>
            <li><strong>What went well:</strong> {{ trade_journal.did_right | join(', ') }}</li>
            <li><strong>What to improve:</strong> {{ trade_journal.improve | join(', ') }}</li>
            <li><strong>Psychological traps:</strong> {{ trade_journal.traps | join(', ') }}</li>
          </ul>
        </div>

        <!-- 5. New Opportunities -->
        <div style="margin:16px 0 10px 0;">
          <div style="font-weight:700;color:#111827;margin-bottom:6px;">5. New Opportunities</div>
          {% if new_opportunities %}
          <ul style='margin:6px 0 0 18px;padding:0;font-size:14px;'>
            {% for o in new_opportunities %}
            <li><strong>{{ o.ticker }} ({{ o.setup }}):</strong> {{ o.reason }}</li>
            {% endfor %}
          </ul>
          {% else %}
          <div style='font-size:14px;color:#6b7280;'>None identified.</div>
          {% endif %}
        </div>

        <!-- 6. Reminders -->
        <div style="margin:16px 0 18px 0;">
          <div style="font-weight:700;color:#111827;margin-bottom:6px;">6. Reminders</div>
          <ul style='margin:6px 0 0 18px;padding:0;font-size:14px;'>
            <li><strong>Max risk per trade:</strong> {{ reminders.max_risk_per_trade }}</li>
            <li><strong>Stop-loss discipline:</strong> {{ reminders.stop_loss_discipline }}</li>
            <li><strong>Emotional check-in:</strong> {{ reminders.emotional_check_in }}</li>
          </ul>
        </div>
      </div>

      <div style="text-align:center;color:#9ca3af;font-size:12px;margin-top:10px;">
        Sent automatically ‚Ä¢ Times shown in Asia/Manila (PHT) <br/>
        {% if verified_at %}
        Prices verified at {{ verified_at.strftime('%Y-%m-%d %H:%M:%S %Z') }}
        {% endif %}
      </div>
    </div>
  </body>
</html>
